"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var dbPromise=void 0;document.addEventListener("DOMContentLoaded",function(){dbPromise=openIndexedDB()});var openIndexedDB=function(){return"serviceWorker"in navigator?idb.open("local-guides-db",1,function(e){e.createObjectStore("restaurants",{keyPath:"id"}).createIndex("by-id","id"),e.createObjectStore("reviews",{keyPath:"id"}).createIndex("by-restaurant-id","restaurant_id")}):Promise.resolve()},DBHelper=function(){function u(){_classCallCheck(this,u)}return _createClass(u,null,[{key:"REMOTE_SERVER_URL",value:function(e,t,n){var r="http://localhost:1337/"+e+"/";return t&&(r+=t+"/"),n&&(r+="?"+n),r}},{key:"favoritesRestaurant",value:function(e){this.updateRestaurantFavoriteStatus(e,"is_favorite=true")}},{key:"unFavoritesRestaurant",value:function(e){this.updateRestaurantFavoriteStatus(e,"is_favorite=false")}},{key:"updateRestaurantFavoriteStatus",value:function(t,e){fetch(u.REMOTE_SERVER_URL("restaurants",t,e),{method:"PUT"}).then(function(e){return 200===e.status?e.json():null}).then(function(e){return e?u.saveRestaurantsToIndexedDB(e):u.loadRestaurantsFromIndexedDB(t)}).catch(function(){return u.loadRestaurantsFromIndexedDB(t)})}},{key:"fetchRestaurants",value:function(t,n){fetch(u.REMOTE_SERVER_URL("restaurants",t)).then(function(e){return 200===e.status?e.json():null}).then(function(e){return e?u.saveRestaurantsToIndexedDB(e):u.loadRestaurantsFromIndexedDB(t)}).catch(function(){return console.error("Can not fetch restaurants from remote server, will load from database!"),u.loadRestaurantsFromIndexedDB(t)}).then(function(e){return n(null,e)})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,a,o){u.fetchRestaurants(null,function(e,t){if(e)o(e,null);else{var n=t;"All Cuisines"!==r&&(n=n.filter(function(e){return e.cuisine_type===r})),"All Neighborhoods"!==a&&(n=n.filter(function(e){return e.neighborhood===a})),o(null,n)}})}},{key:"loadRestaurantsFromIndexedDB",value:function(r){return dbPromise.then(function(e){var t=e.transaction("restaurants").objectStore("restaurants"),n=t.index("by-id");return r?t.get(Number(r)):n.getAll()}).then(function(e){return e})}},{key:"saveRestaurantsToIndexedDB",value:function(r){return dbPromise.then(function(e){if(r){var t=e.transaction("restaurants","readwrite"),n=t.objectStore("restaurants");return n.clear(),r instanceof Array?r.forEach(function(e){n.put(e)}):n.put(r),t.complete}}).then(function(){return r})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"webpSrcsetForRestaurant",value:function(e){return"public/img/webp/1024w/"+e.photograph+".webp 1024w, public/img/webp/640w/"+e.photograph+".webp 640w, public/img/webp/320w/"+e.photograph+".webp 320w"}},{key:"imageSrcsetForRestaurant",value:function(e){return"public/img/jpg/1024w/"+e.photograph+".jpg 1024w, public/img/jpg/640w/"+e.photograph+".jpg 640w, public/img/jpg/320w/"+e.photograph+".jpg 320w"}},{key:"imageUrlForRestaurant",value:function(e){if(e.photograph)return"public/img/jpg/320w/"+e.photograph+".jpg"}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:u.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"addReview",value:function(e,t,n){fetch(u.REMOTE_SERVER_URL("reviews"),{method:"POST",body:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"text/plain"}}).then(function(e){return 201===e.status?e.json():null}).then(function(e){return e?u.saveReviewsToIndexedDB(e):null}).catch(function(){return null}).then(function(e){return e?n(null,e):n("Thanks for your review, will be saved when online!",null)})}},{key:"deleteReview",value:function(e,t){fetch(u.REMOTE_SERVER_URL("reviews",e),{method:"DELETE"}).then(function(e){return 201===e.status?e.json():null}).then(function(e){return e?u.deleteReviewsFromIndexedDB(e):null}).catch(function(){return console.error("Can not delete review!"),null}).then(function(e){return t(e)})}},{key:"fetchReviews",value:function(t,n){fetch(u.REMOTE_SERVER_URL("reviews",null,"restaurant_id="+t)).then(function(e){return 200===e.status?e.json():null}).then(function(e){return e?u.saveReviewsToIndexedDB(e):u.loadReviewsFromIndexedDB(t)}).catch(function(){return console.error("Can not fetch reviews from remote server, will load from database!"),u.loadReviewsFromIndexedDB(t)}).then(function(e){return n(null,e)})}},{key:"saveReviewsToIndexedDB",value:function(r){return dbPromise.then(function(e){if(r){var t=e.transaction("reviews","readwrite"),n=t.objectStore("reviews");return n.clear(),r instanceof Array?r.forEach(function(e){n.put(e)}):n.put(r),t.complete}}).then(function(){return r})}},{key:"deleteReviewsFromIndexedDB",value:function(r){return dbPromise.then(function(e){if(r){var t=e.transaction("reviews","readwrite"),n=t.objectStore("reviews");return r instanceof Array?r.forEach(function(e){n.delete(e)}):n.delete(r),t.complete}}).then(function(){return r})}},{key:"loadReviewsFromIndexedDB",value:function(t){return dbPromise.then(function(e){return e.transaction("reviews").objectStore("reviews").index("by-restaurant-id").getAll(Number(t))}).then(function(e){return e})}}]),u}();